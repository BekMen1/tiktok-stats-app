<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TikTok Stats: Deep Dive+</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ru.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #050505; color: #eee; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    .glass { background: #111; border: 1px solid #222; border-radius: 16px; }
    .neon-red { color: #FE2C55; }
    .neon-cyan { color: #25F4EE; }

    .border-top-grad-views { border-top: 4px solid; border-image: linear-gradient(to right, #ffffff, #999999) 1; }
    .border-top-grad-likes { border-top: 4px solid; border-image: linear-gradient(to right, #FE2C55, #FF0050) 1; }
    .border-top-grad-comms { border-top: 4px solid; border-image: linear-gradient(to right, #25F4EE, #00F0FF) 1; }
    .border-top-grad-misc { border-top: 4px solid; border-image: linear-gradient(to right, #FFD700, #FFA500) 1; }
    .border-top-grad-content { border-top: 4px solid; border-image: linear-gradient(to right, #7C3AED, #EC4899) 1; }
    .border-top-grad-sec { border-top: 4px solid; border-image: linear-gradient(to right, #34D399, #22C55E) 1; }

    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    .loading { animation: pulse 1s infinite; color: #25F4EE; }
  </style>
</head>

<body class="min-h-screen p-4 md:p-10">

  <div class="max-w-7xl mx-auto">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 border-b border-gray-800 pb-8">
      <div class="w-full md:w-auto">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight text-white mb-2">
          TIKTOK <span class="neon-red">DEEP DIVE</span><span class="text-gray-600">+</span>
        </h1>
        <p class="text-gray-500 text-sm">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–∑ TikTok JSON/ZIP: –∫–æ–Ω—Ç–µ–Ω—Ç, –∞—É–¥–∏—Ç–æ—Ä–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Å–æ–æ–±—â–µ–Ω–∏—è, Off-TikTok.</p>
        <div id="profileSummary" class="mt-3 text-xs text-gray-400 font-mono"></div>
      </div>

      <div class="flex flex-col gap-2 w-full md:w-auto">
         <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
       <label class="cursor-pointer bg-white text-black font-bold py-3 px-6 rounded-lg hover:bg-gray-200 transition text-center shadow-[0_0_15px_rgba(255,255,255,0.3)]">
      <span>üìÇ –û—Ç–∫—Ä—ã—Ç—å JSON / ZIP</span>
      <input id="fileInput" type="file" accept=".json,.zip,application/json,application/zip,application/x-zip-compressed" class="hidden"/>
        </label>

           <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
          <button onclick="document.getElementById('helpModal').classList.remove('hidden')" class="text-xs text-gray-500 hover:text-white underline text-center mt-1">
           ‚ùì –ì–¥–µ –≤–∑—è—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?
          </button>

        <div id="controls" class="hidden flex gap-2">
       <select id="yearSelect" class="bg-[#111] border border-[#333] text-white py-3 px-4 rounded-lg outline-none w-full font-mono"></select>
       </div>
          <div id="status" class="text-xs text-gray-500 text-center h-4"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden space-y-12">

      <!-- 1. –ü–†–û–°–ú–û–¢–†–´ -->
      <section>
          <div class="glass p-8 border-top-grad-views relative overflow-hidden">
             <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
             <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
                 <h2 class="text-2xl font-black text-white uppercase tracking-wider">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</h2>
                 <div class="text-xs text-gray-500 font-mono">
                   –°–µ—Å—Å–∏–∏: <span id="mSessions" class="text-white">‚Äî</span> ¬∑ –°—Ä. –≤–∏–¥–µ–æ/—Å–µ—Å—Å–∏—é: <span id="mSessionAvg" class="text-white">‚Äî</span>
                 </div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="space-y-4">
                     <div class="bg-[#1a1a1a] p-6 rounded-xl border border-[#333]">
                         <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-1">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                         <div id="mViews" class="text-4xl font-black text-white">‚Äî</div>
                     </div>
                     <div class="bg-[#1a1a1a] p-6 rounded-xl border border-[#333]">
                         <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-1">‚âà –í—Ä–µ–º—è</div>
                         <div id="mTime" class="text-4xl font-black text-gray-200">‚Äî</div>
                         <div id="mDays" class="text-sm text-gray-500 mt-1">–¥–Ω–µ–π</div>
                         <div class="text-[10px] text-gray-600 mt-2 font-mono">–æ—Ü–µ–Ω–∫–∞: ~20 —Å–µ–∫/–≤–∏–¥–µ–æ</div>
                     </div>
                     <div id="alertBox" class="hidden border border-yellow-600/30 bg-yellow-900/10 p-4 rounded-xl">
                        <p class="text-xs text-yellow-500 font-bold">‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª–Ω—ã–µ</p>
                        <p class="text-xs text-gray-400 mt-1">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞: TikTok –∏–Ω–æ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç –Ω–µ –≤—Å—ë. –û—Å—Ç–∞–ª–∞—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.</p>
                     </div>
                 </div>
                 <div class="lg:col-span-2 bg-[#1a1a1a] p-4 rounded-xl border border-[#333] flex flex-col">
                     <div class="flex-1 min-h-[250px] relative"><canvas id="chartViews"></canvas></div>
                 </div>
             </div>
          </div>
      </section>

      <!-- 2. –õ–ê–ô–ö–ò -->
      <section>
        <div class="glass p-8 border-top-grad-likes relative overflow-hidden">
             <div class="absolute top-0 right-0 w-64 h-64 bg-red-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
             <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
                 <h2 class="text-2xl font-black text-neon-red uppercase tracking-wider">–õ–∞–π–∫–∏</h2>
                 <div class="text-xs text-gray-500 font-mono">
                   –ü–µ—Ä–≤—ã–π: <span id="firstLikeDate" class="text-white">‚Äî</span> ¬∑ –ü–æ—Å–ª–µ–¥–Ω–∏–π: <span id="lastLikeDate" class="text-white">‚Äî</span>
                 </div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="lg:col-span-2 grid grid-cols-1 gap-4">
                     <div class="bg-[#1a1a1a] p-6 rounded-xl border border-[#333]">
                         <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-1">–í—Å–µ–≥–æ –ª–∞–π–∫–æ–≤ (—Ç—ã –ø–æ—Å—Ç–∞–≤–∏–ª)</div>
                         <div id="mLikes" class="text-4xl font-black text-neon-red">‚Äî</div>
                     </div>
                     <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] min-h-[200px]">
                         <div class="h-[200px] w-full"><canvas id="chartLikes"></canvas></div>
                     </div>
                 </div>
                 <div class="flex flex-col gap-4">
                     <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
                         <div class="text-[10px] text-gray-500 uppercase mb-1">–ü–µ—Ä–≤—ã–π –ª–∞–π–∫</div>
                         <div class="flex justify-between items-center">
                             <div id="firstLikeDateBox" class="font-mono text-white text-sm">‚Äî</div>
                             <a id="firstLikeLink" href="#" target="_blank" class="text-[10px] bg-neon-red text-black font-bold px-2 py-1 rounded">–°–º–æ—Ç—Ä–µ—Ç—å</a>
                         </div>
                     </div>
                     <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
                         <div class="text-[10px] text-gray-500 uppercase mb-1">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ª–∞–π–∫</div>
                         <div class="flex justify-between items-center">
                             <div id="lastLikeDateBox" class="font-mono text-white text-sm">‚Äî</div>
                             <a id="lastLikeLink" href="#" target="_blank" class="text-[10px] bg-neon-red text-black font-bold px-2 py-1 rounded">–°–º–æ—Ç—Ä–µ—Ç—å</a>
                         </div>
                     </div>
                     <div class="flex-1 bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col">
                        <div class="bg-[#151515] p-3 text-xs font-bold text-gray-500 uppercase border-b border-[#333]">–°–ø–∏—Å–æ–∫ –ª–∞–π–∫–æ–≤</div>
                        <div class="overflow-y-auto h-[250px]">
                            <table class="w-full text-left"><tbody id="likesTableBody" class="text-sm font-mono text-gray-300"></tbody></table>
                        </div>
                     </div>
                 </div>
             </div>
        </div>
      </section>

      <!-- 3. –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò -->
      <section>
        <div class="glass p-8 border-top-grad-comms relative overflow-hidden">
             <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
             <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
                 <h2 class="text-2xl font-black text-neon-cyan uppercase tracking-wider">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
                 <div class="text-xs text-gray-500 font-mono">
                   –¢–æ–ø —Å–ª–æ–≤–æ/—ç–º–æ–¥–∑–∏: <span id="topCommentToken" class="text-white">‚Äî</span>
                 </div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="lg:col-span-1 space-y-4">
                     <div class="bg-[#1a1a1a] p-6 rounded-xl border border-[#333]">
                         <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-1">–í—Å–µ–≥–æ</div>
                         <div id="mComments" class="text-4xl font-black text-neon-cyan">‚Äî</div>
                     </div>
                     <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] min-h-[200px]">
                         <div class="h-[200px] w-full"><canvas id="chartComments"></canvas></div>
                     </div>
                     <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
                       <div class="text-[10px] text-gray-500 uppercase mb-1">–¢–æ–ø —Ç–æ–∫–µ–Ω—ã (–±—ã—Å—Ç—Ä–æ)</div>
                       <div id="commentTokens" class="text-xs font-mono text-gray-300 leading-relaxed">‚Äî</div>
                     </div>
                 </div>
                 <div class="lg:col-span-2 bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col">
                    <div class="bg-[#151515] p-3 text-xs font-bold text-gray-500 uppercase border-b border-[#333]">–¢–µ–∫—Å—Ç—ã</div>
                    <div class="overflow-y-auto h-[400px]">
                        <table class="w-full text-left">
                            <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase"><tr><th class="p-3 w-32">–î–∞—Ç–∞</th><th class="p-3">–¢–µ–∫—Å—Ç</th><th class="p-3 w-10"></th></tr></thead>
                            <tbody id="commentsTableBody" class="text-sm font-mono text-gray-300"></tbody>
                        </table>
                    </div>
                 </div>
             </div>
        </div>
      </section>

      <!-- 0. CONTENT & AUDIENCE OVERVIEW (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –ø–æ—Å–ª–µ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤) -->
      <section>
        <div class="glass p-8 border-top-grad-content relative overflow-hidden">
          <div class="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
          <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
            <h2 class="text-2xl font-black text-white uppercase tracking-wider">–ö–æ–Ω—Ç–µ–Ω—Ç –∏ —Ä–æ—Å—Ç</h2>
            <div id="dataWarnings" class="text-xs text-gray-500 font-mono"></div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–ü–æ—Å—Ç–æ–≤</div>
              <div id="statPosts" class="text-2xl font-bold text-white">-</div>
              <div id="statPostsRate" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–õ–∞–π–∫–æ–≤ –Ω–∞ –ø–æ—Å—Ç–∞—Ö</div>
              <div id="statPostLikes" class="text-2xl font-bold text-white">-</div>
              <div id="statPostLikesAvg" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
              <div id="statNewFollowers" class="text-2xl font-bold text-white">-</div>
              <div id="statNet" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–£–¥–∞–ª–µ–Ω–æ –ø–æ—Å—Ç–æ–≤</div>
              <div id="statDeleted" class="text-2xl font-bold text-white">-</div>
              <div id="statDeletedLife" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
              <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–ø–æ –ª–∞–π–∫–∞–º)</div>
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-[#111] border border-[#222] rounded-lg p-3">
                  <div class="text-[10px] text-gray-500 uppercase">–ß–∞—Å</div>
                  <div id="bestHour" class="text-white font-black text-xl">‚Äî</div>
                  <div id="bestHourMeta" class="text-[10px] text-gray-500 font-mono mt-1">‚Äî</div>
                </div>
                <div class="bg-[#111] border border-[#222] rounded-lg p-3">
                  <div class="text-[10px] text-gray-500 uppercase">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</div>
                  <div id="bestWeekday" class="text-white font-black text-xl">‚Äî</div>
                  <div id="bestWeekdayMeta" class="text-[10px] text-gray-500 font-mono mt-1">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2 bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
              <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">–ü–æ—Å—Ç—ã –∏ –ª–∞–π–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
              <div class="h-[240px] w-full"><canvas id="chartPosts"></canvas></div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[320px]">
              <div class="bg-[#151515] p-3 text-xs font-bold text-purple-300 uppercase border-b border-[#333]">üèÜ –¢–æ–ø –ø–æ—Å—Ç–æ–≤ –ø–æ –ª–∞–π–∫–∞–º</div>
              <div class="overflow-y-auto flex-1">
                <table class="w-full text-left">
                  <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase">
                    <tr><th class="p-3 w-28">–î–∞—Ç–∞</th><th class="p-3 w-20 text-right">–õ–∞–π–∫–∏</th><th class="p-3">–ó–≤—É–∫</th><th class="p-3 w-10"></th></tr>
                  </thead>
                  <tbody id="topPostsTableBody" class="text-sm font-mono text-gray-300"></tbody>
                </table>
              </div>
            </div>

            <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[320px]">
              <div class="bg-[#151515] p-3 text-xs font-bold text-pink-300 uppercase border-b border-[#333]">üéµ –¢–æ–ø –∑–≤—É–∫–æ–≤ –≤ —Ç–≤–æ–∏—Ö –ø–æ—Å—Ç–∞—Ö</div>
              <div class="overflow-y-auto flex-1">
                <table class="w-full text-left">
                  <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase">
                    <tr><th class="p-3">–ó–≤—É–∫</th><th class="p-3 w-16 text-right">–ü–æ—Å—Ç—ã</th><th class="p-3 w-24 text-right">–õ–∞–π–∫–∏/–ø–æ—Å—Ç</th></tr>
                  </thead>
                  <tbody id="topSoundsPostsTableBody" class="text-sm font-mono text-gray-300"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- 4. LIVE, SHOP, SOUNDS (DEEP DIVE) -->
      <section>
        <div class="glass p-8 border-top-grad-misc relative overflow-hidden">
             <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
                 <h2 class="text-2xl font-black text-yellow-500 uppercase tracking-wider">Live & Shop (Deep Dive)</h2>
                 <div class="text-xs text-gray-500 font-mono">
                   Off-TikTok —Å–æ–±—ã—Ç–∏–π: <span id="statOffTikTok" class="text-white">‚Äî</span>
                 </div>
             </div>

             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                 <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
                     <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–°–º–æ—Ç—Ä–µ–ª Live</div>
                     <div id="statLiveWatch" class="text-2xl font-bold text-white">-</div>
                 </div>
                 <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
                     <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–ü–æ–∫—É–ø–∫–∏</div>
                     <div id="statShop" class="text-2xl font-bold text-white">-</div>
                 </div>
                 <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
                     <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–°–æ—Ö—Ä. –ú—É–∑—ã–∫–∞</div>
                     <div id="statSounds" class="text-2xl font-bold text-white">-</div>
                 </div>
                 <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
                     <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</div>
                     <div id="statFollow" class="text-2xl font-bold text-white">-</div>
                 </div>
             </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[300px]">
                     <div class="bg-[#151515] p-3 text-xs font-bold text-yellow-500 uppercase border-b border-[#333]">üõçÔ∏è –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (Shop)</div>
                     <div class="overflow-y-auto flex-1">
                         <table class="w-full text-left">
                             <tbody id="shopTableBody" class="text-sm font-mono text-gray-300"></tbody>
                         </table>
                     </div>
                 </div>

                 <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[300px]">
                     <div class="bg-[#151515] p-3 text-xs font-bold text-neon-cyan uppercase border-b border-[#333]">üéµ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º—É–∑—ã–∫–∞</div>
                     <div class="overflow-y-auto flex-1">
                         <table class="w-full text-left">
                             <tbody id="soundsTableBody" class="text-sm font-mono text-gray-300"></tbody>
                         </table>
                     </div>
                 </div>

                 <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[300px]">
                     <div class="bg-[#151515] p-3 text-xs font-bold text-neon-red uppercase border-b border-[#333]">üì° –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ LIVE</div>
                     <div class="overflow-y-auto flex-1">
                         <table class="w-full text-left">
                             <tbody id="liveTableBody" class="text-sm font-mono text-gray-300"></tbody>
                         </table>
                     </div>
                 </div>

                 <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[300px]">
                     <div class="bg-[#151515] p-3 text-xs font-bold text-white uppercase border-b border-[#333]">üë• –ù–∞ –∫–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è</div>
                     <div class="overflow-y-auto flex-1">
                         <table class="w-full text-left">
                             <tbody id="followTableBody" class="text-sm font-mono text-gray-300"></tbody>
                         </table>
                     </div>
                 </div>
             </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
               <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[260px]">
                 <div class="bg-[#151515] p-3 text-xs font-bold text-yellow-300 uppercase border-b border-[#333]">üåê Off-TikTok Activity: —Ç–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∏</div>
                 <div class="overflow-y-auto flex-1">
                   <table class="w-full text-left">
                     <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase">
                       <tr><th class="p-3">Source</th><th class="p-3 w-16 text-right">–°–æ–±—ã—Ç–∏—è</th></tr>
                     </thead>
                     <tbody id="offTikTokTableBody" class="text-sm font-mono text-gray-300"></tbody>
                   </table>
                 </div>
               </div>

               <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[260px]">
                 <div class="bg-[#151515] p-3 text-xs font-bold text-gray-200 uppercase border-b border-[#333]">‚öôÔ∏è –°—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∏–∑ —Ñ–∞–π–ª–∞)</div>
                 <div class="p-4 text-xs font-mono text-gray-300 leading-relaxed" id="settingsBox">‚Äî</div>
               </div>
             </div>
        </div>
      </section>

      <!-- 5. SECURITY & MESSAGES -->
      <section>
        <div class="glass p-8 border-top-grad-sec relative overflow-hidden">
          <div class="absolute top-0 right-0 w-64 h-64 bg-green-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

          <div class="flex items-center justify-between gap-3 mb-6 flex-wrap">
            <h2 class="text-2xl font-black text-green-300 uppercase tracking-wider">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <div class="text-xs text-gray-500 font-mono">
              –õ–æ–≥–∏–Ω–æ–≤: <span id="statLogins" class="text-white">‚Äî</span> ¬∑ –£—Å—Ç—Ä–æ–π—Å—Ç–≤: <span id="statDevices" class="text-white">‚Äî</span>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö IP</div>
              <div id="statIPs" class="text-2xl font-bold text-white">-</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–ù–æ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤ –ø–µ—Ä–∏–æ–¥)</div>
              <div id="statNewDevices" class="text-2xl font-bold text-white">-</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–°–æ–æ–±—â–µ–Ω–∏–π</div>
              <div id="statDMs" class="text-2xl font-bold text-white">-</div>
              <div id="statDMsInOut" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333] text-center">
              <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">–¢–æ–ø —á–∞—Ç</div>
              <div id="statTopChat" class="text-sm font-bold text-white truncate px-2">-</div>
              <div id="statTopChatCount" class="text-[10px] text-gray-500 mt-1">‚Äî</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
              <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">–õ–æ–≥–∏–Ω—ã –ø–æ –º–µ—Å—è—Ü–∞–º</div>
              <div class="h-[240px] w-full"><canvas id="chartLogins"></canvas></div>
            </div>

            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[240px]">
                <div class="bg-[#151515] p-3 text-xs font-bold text-green-200 uppercase border-b border-[#333]">üîê –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—Ç–æ–ø)</div>
                <div class="overflow-y-auto flex-1">
                  <table class="w-full text-left">
                    <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase">
                      <tr><th class="p-3">Device</th><th class="p-3 w-16 text-right">–õ–æ–≥–∏–Ω—ã</th></tr>
                    </thead>
                    <tbody id="devicesTableBody" class="text-sm font-mono text-gray-300"></tbody>
                  </table>
                </div>
              </div>

              <div class="bg-[#0a0a0a] rounded-xl border border-[#333] overflow-hidden flex flex-col h-[240px]">
                <div class="bg-[#151515] p-3 text-xs font-bold text-green-200 uppercase border-b border-[#333]">üí¨ –ß–∞—Ç—ã (—Ç–æ–ø)</div>
                <div class="overflow-y-auto flex-1">
                  <table class="w-full text-left">
                    <thead class="bg-[#151515] sticky top-0 text-xs text-gray-500 uppercase">
                      <tr><th class="p-3">Chat</th><th class="p-3 w-16 text-right">Msg</th></tr>
                    </thead>
                    <tbody id="chatsTableBody" class="text-sm font-mono text-gray-300"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>

        </div>
      </section>

      <!-- –ù–ò–ñ–ù–ò–ô –†–ê–ó–î–ï–õ (–ü–æ–∏—Å–∫, –†–µ–ø–æ—Å—Ç—ã, –í–∏–¥–µ–æ) -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass p-6">
            <h3 class="font-bold mb-4 text-gray-300">üîç –ü–æ–∏—Å–∫</h3>
            <div id="searchList" class="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-2"></div>
        </div>
        <div class="glass p-6">
            <h3 class="font-bold mb-4 text-gray-300">‚ÜóÔ∏è –†–µ–ø–æ—Å—Ç—ã</h3>
            <div id="shareList" class="flex flex-col gap-3"></div>
        </div>
        <div class="glass p-6">
            <h3 class="font-bold mb-4 text-gray-300">üìπ –¢–≤–æ–∏ –≤–∏–¥–µ–æ</h3>
            <div class="overflow-x-auto max-h-[300px]">
                <table class="w-full text-left text-sm"><tbody id="postsTableBody" class="text-gray-300 font-mono"></tbody></table>
            </div>
        </div>
      </section>

    </div>
  </div>
  <!-- MODAL: –ò–ù–°–¢–†–£–ö–¶–ò–Ø -->
<div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
  <div class="bg-[#111] border border-[#333] rounded-2xl max-w-md w-full p-6 relative shadow-2xl">
    
    <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
    
    <h3 class="text-xl font-bold text-white mb-4">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?</h3>
    
    <ol class="space-y-4 text-sm text-gray-300 list-decimal pl-4">
      <li>
        <span class="text-white font-bold">–û—Ç–∫—Ä–æ–π TikTok</span><br>
        –ü—Ä–æ—Ñ–∏–ª—å ‚ûù –ú–µ–Ω—é (‚â°) ‚ûù –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å.
      </li>
      <li>
        <span class="text-white font-bold">–ó–∞–ø—Ä–æ—Å–∏ –∞—Ä—Ö–∏–≤</span><br>
        –ê–∫–∫–∞—É–Ω—Ç ‚ûù –°–∫–∞—á–∞—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.
      </li>
      <li class="p-2 bg-red-900/20 border border-red-900/50 rounded-lg">
        <span class="text-red-400 font-bold">‚ö†Ô∏è –í–ê–ñ–ù–û:</span><br>
        –í —Ä–∞–∑–¥–µ–ª–µ "–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞" –≤—ã–±–µ—Ä–∏ <span class="text-white font-bold">JSON</span>. <br>
        (–§–æ—Ä–º–∞—Ç TXT –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç!)
      </li>
      <li>
        <span class="text-white font-bold">–ñ–¥–∏</span><br>
        TikTok —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç 1 –¥–æ 3 –¥–Ω–µ–π. –¢–µ–±–µ –ø—Ä–∏–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
      </li>
      <li>
        <span class="text-white font-bold">–°–∫–∞—á–∞–π –∏ –∑–∞–≥—Ä—É–∑–∏ —Å—é–¥–∞</span><br>
        –°–∫–∞—á–∞–π ZIP-–∞—Ä—Ö–∏–≤ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –≤—ã–±–µ—Ä–∏ –µ–≥–æ –≤ —ç—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
      </li>
    </ol>

    <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="w-full bg-[#222] hover:bg-[#333] text-white font-bold py-3 rounded-lg mt-6 transition">
      –ü–æ–Ω—è—Ç–Ω–æ
    </button>
  </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫—Ä–∞—Å–∏—Ç—å —à–∞–ø–∫—É –¢–µ–ª–µ–≥—Ä–∞–º–∞ –≤ —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç –≤–∞—à–µ–≥–æ —Ñ–æ–Ω–∞
    window.Telegram.WebApp.setHeaderColor('#050505'); 
    window.Telegram.WebApp.setBackgroundColor('#050505'); 
}    
dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.locale('ru');

Chart.defaults.color = '#666';
Chart.defaults.borderColor = '#222';
Chart.defaults.font.family = "'Inter', sans-serif";

const $ = (id) => document.getElementById(id);

let STATE = {
  data: null,
  years: [],
  profile: null,
  settings: null
};

// ---------- UTIL ----------
function parseDate(v) {
  if (v === null || v === undefined) return null;

  if (typeof v === 'number') {
    if (v > 1000000000000) return new Date(v);              // ms
    if (v > 1000000000) return dayjs.unix(v).toDate();      // sec
    return null;
  }

  const s0 = String(v).trim();
  if (!s0) return null;

  // numeric string unix timestamp
  const sNum = s0.replace(/\s+/g,'');
  if (/^\d{10,13}$/.test(sNum)) {
    const n = Number(sNum);
    if (!Number.isFinite(n)) return null;
    return sNum.length === 13 ? new Date(n) : dayjs.unix(n).toDate();
  }

  // cleanup "(UTC +00)" suffix etc
  const s = s0.replace(/\s*\(UTC.*\)$/i, "").trim();

  const formats = [
    "YYYY-MM-DD HH:mm:ss",
    "YYYY-MM-DD",
    "YYYY/MM/DD HH:mm:ss",
    "DD/MM/YYYY hh:mm:ssA",
    "DD/MM/YYYY h:mm:ssA",
    "DD/MM/YYYY HH:mm:ss",
    "DD/MM/YYYY",
  ];

  for (const f of formats) {
    const d = dayjs(s, f, true);
    if (d.isValid()) return d.toDate();
  }

  const fallback = new Date(s);
  return isNaN(fallback.getTime()) ? null : fallback;
}

function getYear(d) { return d ? dayjs(d).format("YYYY") : null; }

function walk(root, visitor) {
  const stack = [root];
  while (stack.length) {
    const node = stack.pop();
    if (!node || typeof node !== 'object') continue;

    visitor(node);

    if (Array.isArray(node)) {
      for (let i = 0; i < node.length; i++) stack.push(node[i]);
    } else {
      for (const k in node) stack.push(node[k]);
    }
  }
}

function collectArrayByKey(root, key, out) {
  walk(root, (node) => {
    if (!node || typeof node !== 'object') return;
    if (Object.prototype.hasOwnProperty.call(node, key)) {
      const v = node[key];
      if (Array.isArray(v)) out.push(...v);
    }
  });
}

function collectFirstObjectByKey(root, key) {
  let found = null;
  walk(root, (node) => {
    if (found) return;
    if (!node || typeof node !== 'object' || Array.isArray(node)) return;
    if (Object.prototype.hasOwnProperty.call(node, key)) {
      const v = node[key];
      if (v && typeof v === 'object' && !Array.isArray(v)) found = v;
    }
  });
  return found;
}

function getLink(x) { return x?.Link || x?.link || x?.Url || x?.url || x?.VideoLink || x?.AIGenImageURL || ""; }

function extractFirstUrl(text) {
  const s = String(text || "");
  const m = s.match(/https?:\/\/\S+/);
  if (!m) return "";
  return m[0].replace(/[)\],]+$/g, "");
}

function getCommentText(x) { return x?.Comment || x?.comment || x?.CommentContent || x?.text || "–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"; }
function getShopItem(x) { return x?.ProductName || x?.ItemName || x?.Title || x?.product_name || "–¢–æ–≤–∞—Ä –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"; }
function getSoundName(x) { return x?.SoundName || x?.Title || x?.MusicName || x?.Sound || "–¢—Ä–µ–∫ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"; }
function getUserName(x) { return x?.UserName || x?.Username || x?.user_name || x?.ContactName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"; }

function toInt(v) {
  const n = Number(String(v ?? "").replace(/[^\d.-]/g, ""));
  return Number.isFinite(n) ? n : 0;
}

function median(nums) {
  const a = nums.filter(n => Number.isFinite(n)).slice().sort((x,y)=>x-y);
  if (!a.length) return 0;
  const mid = Math.floor(a.length/2);
  return a.length % 2 ? a[mid] : (a[mid-1] + a[mid]) / 2;
}

function groupByMonthCount(arr) {
  const r = Array(12).fill(0);
  arr.forEach(x => { const d = x?._date; if (!d) return; r[dayjs(d).month()]++; });
  return r;
}

function groupByMonthSum(arr, valueFn) {
  const r = Array(12).fill(0);
  arr.forEach(x => {
    const d = x?._date; if (!d) return;
    const m = dayjs(d).month();
    r[m] += valueFn(x) || 0;
  });
  return r;
}

function simpleTokenize(text) {
  const s = String(text || "").toLowerCase();
  const words = s
    .replace(/https?:\/\/\S+/g, " ")
    .replace(/[0-9]/g, " ")
    .split(/[\s.,!?:;"'(){}\[\]\-_/\\|<>@#%^&*+=~`]+/g)
    .filter(w => w && w.length >= 2);

  const emoji = (String(text || "").match(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/gu) || []);
  return [...emoji, ...words];
}

function bestAvgByKey(items, keyFn, valFn) {
  const m = new Map();
  items.forEach(it => {
    const key = keyFn(it);
    const v = valFn(it);
    const cur = m.get(key) || { count: 0, sum: 0 };
    cur.count++;
    cur.sum += v;
    m.set(key, cur);
  });
  let best = null;
  for (const [k, {count, sum}] of m.entries()) {
    const avg = count ? sum / count : 0;
    if (!best || avg > best.avg) best = { key: k, avg, count, sum };
  }
  return best;
}

function computeSessions(watchArr, gapMinutes = 30) {
  const a = watchArr.slice().sort((x,y)=>x._date - y._date);
  const gap = gapMinutes * 60 * 1000;
  const sessions = [];
  let cur = null;

  for (const it of a) {
    if (!it._date) continue;
    if (!cur) {
      cur = { start: it._date, end: it._date, count: 1 };
      continue;
    }
    const dt = it._date - cur.end;
    if (dt <= gap) {
      cur.end = it._date;
      cur.count++;
    } else {
      sessions.push(cur);
      cur = { start: it._date, end: it._date, count: 1 };
    }
  }
  if (cur) sessions.push(cur);
  return sessions;
}

// ---------- EXTRACTORS ----------
function extractWatchLiveMap(root, out) {
  walk(root, (node) => {
    if (!node || typeof node !== 'object' || Array.isArray(node)) return;
    if (!Object.prototype.hasOwnProperty.call(node, "WatchLiveMap")) return;

    const map = node.WatchLiveMap;
    if (!map || typeof map !== 'object' || Array.isArray(map)) return;

    for (const liveId in map) {
      const v = map[liveId];
      if (!v || typeof v !== 'object') continue;
      out.push({
        ...v,
        _liveId: liveId,
        WatchTime: v.WatchTime || v.watchTime || v.Time || v.Date,
        Link: v.Link || v.link || ""
      });
    }
  });
}

function extractDMs(root, out) {
  walk(root, (node) => {
    if (!node || typeof node !== 'object' || Array.isArray(node)) return;
    for (const k in node) {
      if (typeof k !== 'string') continue;
      const low = k.toLowerCase();
      if (!low.startsWith("chat history with")) continue;

      const arr = node[k];
      if (!Array.isArray(arr)) continue;

      const chat = k.replace(/^Chat History with\s*/i, "").replace(/:$/,"").trim();
      for (const msg of arr) {
        out.push({
          ...msg,
          _chat: chat,
          _link: extractFirstUrl(msg?.Content || msg?.content || "")
        });
      }
    }
  });
}

// ---------- FILE PROCESS ----------
async function processFile(file) {
  $("status").innerText = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
  $("status").classList.add("loading");

  let jsons = [];
  if (file.name.endsWith(".zip")) {
    const zip = await JSZip.loadAsync(file);
    const files = Object.keys(zip.files).filter(n => n.toLowerCase().endsWith(".json"));
    for (const f of files) {
      const txt = await zip.files[f].async("string");
      try { jsons.push(JSON.parse(txt)); } catch(e) {}
    }
  } else {
    const txt = await file.text();
    jsons.push(JSON.parse(txt));
  }

  if (!jsons.length) throw new Error("JSON –Ω–µ –Ω–∞–π–¥–µ–Ω");

  const raw = {
    videoLists: [],
    likes: [],
    comments: [],
    searches: [],
    shares: [],
    liveWatch: [],
    sounds: [],
    shop: [],
    following: [],
    followers: [],
    deletedPosts: [],
    logins: [],
    offTikTok: [],
    dms: [],
    settingsMaps: [],
    profileMaps: []
  };

  jsons.forEach(root => {
    collectArrayByKey(root, "VideoList", raw.videoLists);
    collectArrayByKey(root, "ItemFavoriteList", raw.likes);
    collectArrayByKey(root, "CommentsList", raw.comments);
    collectArrayByKey(root, "SearchList", raw.searches);
    collectArrayByKey(root, "ShareHistoryList", raw.shares);

    extractWatchLiveMap(root, raw.liveWatch);
    collectArrayByKey(root, "FavoriteSoundList", raw.sounds);

    collectArrayByKey(root, "OrderHistories", raw.shop);
    collectArrayByKey(root, "OrderHistoryList", raw.shop);
    collectArrayByKey(root, "OrderHistoriesList", raw.shop);

    collectArrayByKey(root, "Following", raw.following);
    collectArrayByKey(root, "FansList", raw.followers);

    collectArrayByKey(root, "PostList", raw.deletedPosts);

    collectArrayByKey(root, "LoginHistoryList", raw.logins);

    collectArrayByKey(root, "OffTikTokActivityDataList", raw.offTikTok);

    extractDMs(root, raw.dms);

    const settingsMap = collectFirstObjectByKey(root, "SettingsMap");
    if (settingsMap) raw.settingsMaps.push(settingsMap);

    const profileMap = collectFirstObjectByKey(root, "ProfileMap");
    if (profileMap) raw.profileMaps.push(profileMap);
  });

  const onlyWatch = raw.videoLists.filter(x => !Object.prototype.hasOwnProperty.call(x, "Likes"));
  const onlyPosts = raw.videoLists.filter(x => Object.prototype.hasOwnProperty.call(x, "Likes"));

  const clean = (arr, type) => {
    const out = [];
    const seen = new Set();

    for (const x of arr) {
      let d =
        parseDate(x?.Date) ||
        parseDate(x?.date) ||
        parseDate(x?.Time) ||
        parseDate(x?.WatchTime) ||
        parseDate(x?.OrderTime) ||
        parseDate(x?.TimeStamp);

      if (type === 'deleted') {
        const dd = parseDate(x?.DateDeleted);
        d = dd || d;
      }

      if (!d) continue;

      const link = getLink(x) || x?._link || extractFirstUrl(x?.Content || "");
      const item = { ...x, _date: d, Link: link };

      if (type === 'comment') item.Comment = getCommentText(x);
      if (type === 'shop') item.Product = getShopItem(x);
      if (type === 'sound') item.Sound = getSoundName(x);
      if (type === 'user') item.User = getUserName(x);
      if (type === 'dm') {
        item.Chat = x?._chat || "Chat";
        item.From = x?.From || x?.from || "";
        item.Content = x?.Content || x?.content || "";
        item.MsgLink = x?._link || extractFirstUrl(item.Content);
      }
      if (type === 'off') {
        item.Source = x?.Source || x?.source || "Unknown";
        item.Event = x?.Event || x?.event || "Unknown";
      }
      if (type === 'login') {
        item.IP = x?.IP || x?.ip || "";
        item.DeviceModel = x?.DeviceModel || x?.device_model || x?.Device || "Unknown";
        item.NetworkType = x?.NetworkType || x?.network_type || "Unknown";
        item.Carrier = x?.Carrier || x?.carrier || "Unknown";
        item.DeviceSystem = x?.DeviceSystem || x?.device_system || "";
      }
      if (type === 'post') {
        item.LikesN = toInt(x?.Likes);
        item.Sound = x?.Sound || "";
      }
      if (type === 'deleted') {
        item.CreatedAt = parseDate(x?.Date) || null;
        item.DeletedAt = parseDate(x?.DateDeleted) || null;
        item.LikesN = toInt(x?.Likes);
      }

      const dedupeKey = [
        item._date?.getTime() || 0,
        type,
        item.Link || "",
        item.User || item.Chat || "",
        item.Comment || item.Product || item.Source || item.DeviceModel || ""
      ].join("|");

      if (seen.has(dedupeKey)) continue;
      seen.add(dedupeKey);
      out.push(item);
    }

    return out.sort((a,b) => a._date - b._date);
  };

  STATE.profile = raw.profileMaps.length ? raw.profileMaps[raw.profileMaps.length - 1] : null;
  STATE.settings = raw.settingsMaps.length ? raw.settingsMaps[raw.settingsMaps.length - 1] : null;

  STATE.data = {
    watch: clean(onlyWatch, 'watch'),
    likes: clean(raw.likes, 'like'),
    comments: clean(raw.comments, 'comment'),
    searches: clean(raw.searches, 'search'),
    shares: clean(raw.shares, 'share'),
    posts: clean(onlyPosts, 'post'),
    liveWatch: clean(raw.liveWatch, 'live'),
    sounds: clean(raw.sounds, 'sound'),
    shop: clean(raw.shop, 'shop'),
    following: clean(raw.following, 'user'),
    followers: clean(raw.followers, 'user'),
    deletedPosts: clean(raw.deletedPosts, 'deleted'),
    logins: clean(raw.logins, 'login'),
    offTikTok: clean(raw.offTikTok, 'off'),
    dms: clean(raw.dms, 'dm')
  };

  // Years from ALL datasets
  const years = new Set();
  Object.values(STATE.data).forEach(arr => arr.forEach(x => years.add(getYear(x._date))));
  const list = Array.from(years).filter(Boolean).sort().reverse();

  // –í–ê–ñ–ù–û: ALL –≤ –∫–æ–Ω—Ü–µ, –ø–µ—Ä–≤—ã–º ‚Äî —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –≥–æ–¥
  STATE.years = list.length ? [...list, "ALL"] : ["ALL"];

  renderProfileSummary();
  return STATE.years;
}

function renderProfileSummary() {
  const pm = STATE.profile;
  if (!pm) { $("profileSummary").innerText = ""; return; }

  const username = pm.userName || pm.username || "";
  const displayName = pm.displayName || pm.Name || "";
  const followerCount = pm.followerCount ?? pm.FollowerCount;
  const followingCount = pm.followingCount ?? pm.FollowingCount;
  const likesReceived = pm.likesReceived ?? pm.LikesReceived;

  const parts = [];
  if (displayName || username) parts.push(`${displayName ? displayName : ""}${username ? " @" + username : ""}`.trim());
  if (Number.isFinite(followerCount)) parts.push(`followers: ${Number(followerCount).toLocaleString()}`);
  if (Number.isFinite(followingCount)) parts.push(`following: ${Number(followingCount).toLocaleString()}`);
  if (likesReceived !== undefined && likesReceived !== null && String(likesReceived) !== "") parts.push(`likes received: ${String(likesReceived)}`);
  $("profileSummary").innerText = parts.join(" ¬∑ ");
}

// ---------- RENDER ----------
function renderUI(year) {
  const d = STATE.data;

  const filter = (arr) => year === "ALL" ? arr : arr.filter(x => getYear(x._date) === year);

  const curr = {
    watch: filter(d.watch),
    likes: filter(d.likes),
    comments: filter(d.comments),
    searches: filter(d.searches),
    shares: filter(d.shares),
    posts: filter(d.posts),
    liveWatch: filter(d.liveWatch),
    sounds: filter(d.sounds),
    shop: filter(d.shop),
    following: filter(d.following),
    followers: filter(d.followers),
    deletedPosts: filter(d.deletedPosts),
    logins: filter(d.logins),
    offTikTok: filter(d.offTikTok),
    dms: filter(d.dms),
  };

  // ---------- CONTENT & GROWTH ----------
  const postsCount = curr.posts.length;
  const postLikesSum = curr.posts.reduce((acc,p)=>acc + (p.LikesN || toInt(p.Likes)), 0);
  const likesArr = curr.posts.map(p => p.LikesN || toInt(p.Likes));
  const postLikesAvg = postsCount ? postLikesSum / postsCount : 0;
  const postLikesMed = median(likesArr);

  $("statPosts").innerText = postsCount.toLocaleString();
  $("statPostLikes").innerText = postLikesSum.toLocaleString();
  $("statPostLikesAvg").innerText = postsCount ? `—Å—Ä: ${Math.round(postLikesAvg).toLocaleString()} ¬∑ –º–µ–¥: ${Math.round(postLikesMed).toLocaleString()}` : "‚Äî";

  if (postsCount >= 2) {
    const first = curr.posts[0]._date;
    const last = curr.posts[curr.posts.length-1]._date;
    const days = Math.max(1, dayjs(last).diff(dayjs(first), 'day'));
    const perWeek = postsCount / (days/7);
    $("statPostsRate").innerText = `‚âà ${perWeek.toFixed(2)} –ø–æ—Å—Ç–∞/–Ω–µ–¥`;
  } else {
    $("statPostsRate").innerText = "‚Äî";
  }

  const bestH = bestAvgByKey(curr.posts, p => dayjs(p._date).hour(), p => (p.LikesN || toInt(p.Likes)));
  const weekNames = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"];
  const bestW = bestAvgByKey(curr.posts, p => dayjs(p._date).day(), p => (p.LikesN || toInt(p.Likes)));

  $("bestHour").innerText = bestH ? `${String(bestH.key).padStart(2,"0")}:00` : "‚Äî";
  $("bestHourMeta").innerText = bestH ? `avg ${Math.round(bestH.avg).toLocaleString()} ¬∑ n=${bestH.count}` : "‚Äî";

  $("bestWeekday").innerText = bestW ? weekNames[Number(bestW.key)] : "‚Äî";
  $("bestWeekdayMeta").innerText = bestW ? `avg ${Math.round(bestW.avg).toLocaleString()} ¬∑ n=${bestW.count}` : "‚Äî";

  $("statDeleted").innerText = curr.deletedPosts.length.toLocaleString();
  if (curr.deletedPosts.length) {
    const lifedays = curr.deletedPosts
      .map(p => {
        const c = p.CreatedAt ? dayjs(p.CreatedAt) : null;
        const del = p.DeletedAt ? dayjs(p.DeletedAt) : null;
        if (!c || !del) return null;
        return del.diff(c, 'day', true);
      })
      .filter(x => x !== null && Number.isFinite(x));

    if (lifedays.length) {
      const avgLife = lifedays.reduce((a,b)=>a+b,0) / lifedays.length;
      $("statDeletedLife").innerText = `—Å—Ä –∂–∏–∑–Ω—å: ${avgLife.toFixed(1)} –¥–Ω`;
    } else {
      $("statDeletedLife").innerText = "—Å—Ä –∂–∏–∑–Ω—å: ‚Äî";
    }
  } else {
    $("statDeletedLife").innerText = "‚Äî";
  }

  $("statNewFollowers").innerText = curr.followers.length.toLocaleString();
  const net = curr.followers.length - curr.following.length;
  $("statNet").innerText = `–Ω–µ—Ç—Ç–æ: ${net >= 0 ? "+" : ""}${net.toLocaleString()} (followers - following)`;

  const topPosts = curr.posts
    .slice()
    .sort((a,b) => (b.LikesN||0) - (a.LikesN||0))
    .slice(0, 15);

  $("topPostsTableBody").innerHTML = topPosts.length ? topPosts.map(p => `
    <tr class="border-b border-[#222] hover:bg-[#111] align-top">
      <td class="p-3 text-gray-500 whitespace-nowrap">${dayjs(p._date).format("DD.MM")}</td>
      <td class="p-3 text-right font-bold text-white">${(p.LikesN||0).toLocaleString()}</td>
      <td class="p-3 text-gray-300">${(p.Sound || "‚Äî").slice(0, 70)}</td>
      <td class="p-3 text-center">${p.Link ? `<a href="${p.Link}" target="_blank" class="text-purple-300 underline">‚Üó</a>` : ""}</td>
    </tr>
  `).join("") : `<tr><td colspan="4" class="p-4 text-center text-gray-600">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</td></tr>`;

  const soundMap = new Map();
  curr.posts.forEach(p => {
    const s = (p.Sound || "").trim() || "‚Äî";
    const curS = soundMap.get(s) || { count: 0, likesSum: 0 };
    curS.count++;
    curS.likesSum += (p.LikesN || 0);
    soundMap.set(s, curS);
  });

  const topSounds = Array.from(soundMap.entries())
    .map(([sound, v]) => ({ sound, ...v, avg: v.count ? v.likesSum / v.count : 0 }))
    .sort((a,b) => b.count - a.count)
    .slice(0, 20);

  $("topSoundsPostsTableBody").innerHTML = topSounds.length ? topSounds.map(x => `
    <tr class="border-b border-[#222] hover:bg-[#111]">
      <td class="p-3 text-gray-300">${String(x.sound).slice(0, 80)}</td>
      <td class="p-3 text-right text-white font-bold">${x.count}</td>
      <td class="p-3 text-right text-gray-300">${Math.round(x.avg).toLocaleString()}</td>
    </tr>
  `).join("") : `<tr><td colspan="3" class="p-4 text-center text-gray-600">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–≤—É–∫–∞–º</td></tr>`;

  const warns = [];
  if (!curr.watch.length && (curr.likes.length || curr.comments.length)) warns.push("Watch History –ø—É—Å—Ç–∞—è");
  if (!curr.posts.length) warns.push("Posts –ø—É—Å—Ç—ã–µ/–Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
  $("dataWarnings").innerText = warns.length ? ("‚ö† " + warns.join(" ¬∑ ")) : "";

  // ---------- 1. VIEWS & TIME ----------
  $("mViews").innerText = curr.watch.length.toLocaleString();

  const sessions = computeSessions(curr.watch, 30);
  $("mSessions").innerText = sessions.length.toLocaleString();
  const avgPerSession = sessions.length ? (sessions.reduce((a,s)=>a+s.count,0) / sessions.length) : 0;
  $("mSessionAvg").innerText = sessions.length ? avgPerSession.toFixed(1) : "‚Äî";

  const totalSeconds = curr.watch.length * 20;
  const hours = Math.floor(totalSeconds / 3600);
  const days = totalSeconds / 86400;
  $("mTime").innerText = hours > 0 ? (hours + " —á") : "0 —á";
  $("mDays").innerText = "‚âà " + days.toFixed(1) + " –¥–Ω";

  if (curr.watch.length === 0 && (curr.likes.length > 0 || curr.comments.length > 0)) $("alertBox").classList.remove("hidden");
  else $("alertBox").classList.add("hidden");

  // ---------- 2. LIKES ----------
  $("mLikes").innerText = curr.likes.length.toLocaleString();

  if (curr.likes.length > 0) {
    const first = curr.likes[0];
    const last = curr.likes[curr.likes.length - 1];

    $("firstLikeDate").innerText = dayjs(first._date).format("DD MMM HH:mm");
    $("lastLikeDate").innerText = dayjs(last._date).format("DD MMM HH:mm");

    $("firstLikeDateBox").innerText = dayjs(first._date).format("DD MMM HH:mm");
    $("firstLikeLink").href = first.Link || "#";

    $("lastLikeDateBox").innerText = dayjs(last._date).format("DD MMM HH:mm");
    $("lastLikeLink").href = last.Link || "#";

    $("likesTableBody").innerHTML = curr.likes
      .slice()
      .sort((a,b)=>b._date - a._date)
      .slice(0, 200)
      .map(l => `
        <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="p-3 text-gray-500">${dayjs(l._date).format("DD.MM HH:mm")}</td>
          <td class="p-3 text-right"><a href="${l.Link || "#"}" target="_blank" class="text-neon-red underline hover:text-white">–°–º–æ—Ç—Ä–µ—Ç—å</a></td>
        </tr>`
      ).join("");
  } else {
    $("firstLikeDate").innerText = "‚Äî";
    $("lastLikeDate").innerText = "‚Äî";
    $("firstLikeDateBox").innerText = "‚Äî";
    $("lastLikeDateBox").innerText = "‚Äî";
    $("firstLikeLink").href = "#";
    $("lastLikeLink").href = "#";
    $("likesTableBody").innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç –ª–∞–π–∫–æ–≤</td></tr>';
  }

  // ---------- 3. COMMENTS ----------
  $("mComments").innerText = curr.comments.length.toLocaleString();
  if (curr.comments.length > 0) {
    $("commentsTableBody").innerHTML = curr.comments
      .slice()
      .sort((a,b) => b._date - a._date)
      .slice(0, 300)
      .map(c => `
        <tr class="border-b border-[#222] hover:bg-[#111] align-top">
          <td class="p-3 text-gray-500 whitespace-nowrap">${dayjs(c._date).format("DD.MM HH:mm")}</td>
          <td class="p-3 text-white break-words">${c.Comment || getCommentText(c)}</td>
          <td class="p-3 text-center">${c.Link ? `<a href="${c.Link}" target="_blank" class="text-neon-cyan">‚Üó</a>` : ''}</td>
        </tr>`
      ).join("");
  } else {
    $("commentsTableBody").innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-600">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</td></tr>';
  }

  const tokenCount = new Map();
  curr.comments.forEach(c => {
    for (const t of simpleTokenize(c.Comment || getCommentText(c))) {
      tokenCount.set(t, (tokenCount.get(t) || 0) + 1);
    }
  });
  const topTokens = Array.from(tokenCount.entries())
    .sort((a,b)=>b[1]-a[1])
    .slice(0, 12);

  $("topCommentToken").innerText = topTokens.length ? `${topTokens[0][0]} (${topTokens[0][1]})` : "‚Äî";
  $("commentTokens").innerHTML = topTokens.length
    ? topTokens.map(([t,c]) => `<span class="inline-block bg-[#111] border border-[#222] rounded px-2 py-1 mr-2 mb-2">${t}<span class="text-gray-500">√ó${c}</span></span>`).join("")
    : "‚Äî";

  // ---------- 4. DEEP DIVE ----------
  $("statLiveWatch").innerText = curr.liveWatch.length;
  $("statShop").innerText = curr.shop.length;
  $("statSounds").innerText = curr.sounds.length;
  $("statFollow").innerText = curr.following.length;

  $("statOffTikTok").innerText = curr.offTikTok.length.toLocaleString();

  renderSettingsBox();

  if (curr.shop.length > 0) {
    $("shopTableBody").innerHTML = curr.shop
      .slice()
      .sort((a,b)=>b._date - a._date)
      .slice(0, 120)
      .map(x => `
        <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="p-3 text-gray-500">${dayjs(x._date).format("DD.MM")}</td>
          <td class="p-3 text-white">${x.Product || getShopItem(x)}</td>
        </tr>
      `).join("");
  } else $("shopTableBody").innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫</td></tr>';

  if (curr.sounds.length > 0) {
    $("soundsTableBody").innerHTML = curr.sounds
      .slice()
      .sort((a,b)=>b._date - a._date)
      .slice(0, 120)
      .map(x => `
        <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="p-3 text-gray-500">${dayjs(x._date).format("DD.MM")}</td>
          <td class="p-3 text-white">${x.Link ? `<a href="${x.Link}" target="_blank" class="hover:text-neon-cyan">${x.Sound || getSoundName(x)}</a>` : (x.Sound || getSoundName(x))}</td>
        </tr>
      `).join("");
  } else $("soundsTableBody").innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤</td></tr>';

  if (curr.liveWatch.length > 0) {
    $("liveTableBody").innerHTML = curr.liveWatch
      .slice()
      .sort((a,b)=>b._date - a._date)
      .slice(0, 120)
      .map(x => `
        <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="p-3 text-gray-500">${dayjs(x._date).format("DD.MM HH:mm")}</td>
          <td class="p-3">${x.Link ? `<a href="${x.Link}" target="_blank" class="text-neon-red underline">–û—Ç–∫—Ä—ã—Ç—å</a>` : `<span class="text-gray-600">‚Äî</span>`}</td>
        </tr>
      `).join("");
  } else $("liveTableBody").innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ Live</td></tr>';

  if (curr.following.length > 0) {
    $("followTableBody").innerHTML = curr.following
      .slice()
      .sort((a,b)=>b._date - a._date)
      .slice(0, 150)
      .map(x => `
        <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="p-3 text-gray-500">${dayjs(x._date).format("DD.MM")}</td>
          <td class="p-3 text-white font-bold">@${x.User || getUserName(x)}</td>
        </tr>
      `).join("");
  } else $("followTableBody").innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</td></tr>';

  const srcCount = new Map();
  curr.offTikTok.forEach(x => {
    const s = x.Source || "Unknown";
    srcCount.set(s, (srcCount.get(s) || 0) + 1);
  });
  const topSources = Array.from(srcCount.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 30);
  $("offTikTokTableBody").innerHTML = topSources.length
    ? topSources.map(([s,c]) => `
      <tr class="border-b border-[#222] hover:bg-[#111]">
        <td class="p-3 text-gray-300">${String(s).slice(0, 80)}</td>
        <td class="p-3 text-right text-white font-bold">${c}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç Off-TikTok –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td></tr>`;

  // ---------- 5. SECURITY & MESSAGES ----------
  $("statLogins").innerText = curr.logins.length.toLocaleString();

  const deviceCount = new Map();
  const ipCount = new Set();

  curr.logins.forEach(l => {
    const dev = (l.DeviceModel || "Unknown").trim();
    deviceCount.set(dev, (deviceCount.get(dev) || 0) + 1);
    if (l.IP) ipCount.add(l.IP);
  });

  const devicesSorted = Array.from(deviceCount.entries()).sort((a,b)=>b[1]-a[1]);
  $("statDevices").innerText = devicesSorted.length.toLocaleString();
  $("statIPs").innerText = ipCount.size.toLocaleString();

  const firstSeen = new Map(); // device -> date
  d.logins.forEach(l => {
    const dev = (l.DeviceModel || "Unknown").trim();
    const t = l._date?.getTime?.() || null;
    if (!t) return;
    const prev = firstSeen.get(dev);
    if (!prev || t < prev) firstSeen.set(dev, t);
  });
  const newDevicesInPeriod = devicesSorted.filter(([dev]) => {
    const t = firstSeen.get(dev);
    if (!t) return false;
    const y = getYear(new Date(t));
    return (year === "ALL") ? true : (y === year);
  }).length;
  $("statNewDevices").innerText = (year === "ALL") ? "‚Äî" : newDevicesInPeriod.toLocaleString();

  $("devicesTableBody").innerHTML = devicesSorted.length
    ? devicesSorted.slice(0, 40).map(([dev,c]) => `
      <tr class="border-b border-[#222] hover:bg-[#111]">
        <td class="p-3 text-gray-300">${String(dev).slice(0, 50)}</td>
        <td class="p-3 text-right text-white font-bold">${c}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ª–æ–≥–∏–Ω–æ–≤</td></tr>`;

  $("statDMs").innerText = curr.dms.length.toLocaleString();
  const myUsername = (STATE.profile?.userName || STATE.profile?.username || "").toLowerCase();

  let inCnt = 0, outCnt = 0;
  const chatCount = new Map();

  curr.dms.forEach(m => {
    const chat = m.Chat || "Chat";
    chatCount.set(chat, (chatCount.get(chat) || 0) + 1);

    const from = String(m.From || "").toLowerCase();
    if (myUsername && from === myUsername) outCnt++;
    else inCnt++;
  });

  $("statDMsInOut").innerText = `–≤—Ö–æ–¥: ${inCnt.toLocaleString()} ¬∑ –∏—Å—Ö–æ–¥: ${outCnt.toLocaleString()}`;

  const chatsSorted = Array.from(chatCount.entries()).sort((a,b)=>b[1]-a[1]);
  $("statTopChat").innerText = chatsSorted.length ? chatsSorted[0][0] : "‚Äî";
  $("statTopChatCount").innerText = chatsSorted.length ? `—Å–æ–æ–±—â–µ–Ω–∏–π: ${chatsSorted[0][1]}` : "‚Äî";

  $("chatsTableBody").innerHTML = chatsSorted.length
    ? chatsSorted.slice(0, 40).map(([chat,c]) => `
      <tr class="border-b border-[#222] hover:bg-[#111]">
        <td class="p-3 text-gray-300">${String(chat).slice(0, 60)}</td>
        <td class="p-3 text-right text-white font-bold">${c}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="p-4 text-center text-gray-600">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</td></tr>`;

  // ---------- SEARCH LIST ----------
  const sCount = {};
  curr.searches.forEach(x => {
    const t = x.SearchTerm || x.searchTerm || x.Term || "‚Äî";
    sCount[t] = (sCount[t] || 0) + 1;
  });
  const topS = Object.entries(sCount).sort((a,b)=>b[1]-a[1]).slice(0, 20);
  $("searchList").innerHTML = topS.map(([t,c], i) => `
      <div class="flex justify-between items-center hover:bg-white/5 p-2 rounded transition">
          <div class="flex items-center gap-3 overflow-hidden">
              <span class="text-xs font-mono text-gray-600 w-4">${i+1}</span>
              <span class="truncate text-gray-300 text-sm">${t}</span>
          </div>
          <span class="text-xs text-neon-cyan font-bold">${c}</span>
      </div>
  `).join("") || '<div class="text-gray-600 text-sm">–ü—É—Å—Ç–æ</div>';

  // ---------- SHARE LIST ----------
  const shCount = {};
  curr.shares.forEach(x => {
    const m = x.Method || x.method || "Unknown";
    shCount[m] = (shCount[m] || 0) + 1;
  });
  const sharesTotal = Math.max(1, curr.shares.length);
  $("shareList").innerHTML = Object.entries(shCount)
    .sort((a,b)=>b[1]-a[1])
    .map(([m,c]) => `
      <div class="text-sm">
          <div class="flex justify-between mb-1">
            <span class="text-gray-400 font-bold uppercase text-xs">${m}</span>
            <span class="text-white">${c}</span>
          </div>
          <div class="h-1.5 bg-[#222] rounded-full overflow-hidden">
            <div class="h-full bg-gray-500" style="width: ${(c/sharesTotal)*100}%"></div>
          </div>
      </div>
  `).join("") || '<div class="text-gray-600 text-sm">–ü—É—Å—Ç–æ</div>';

  // ---------- POSTS TABLE ----------
  const sortedPosts = curr.posts.slice().sort((a,b) => (b.LikesN||0) - (a.LikesN||0));
  $("postsTableBody").innerHTML = sortedPosts.map(p => `
      <tr class="border-b border-[#222] hover:bg-[#111]">
          <td class="pl-2 py-3 text-gray-500">${dayjs(p._date).format("DD.MM")}</td>
          <td class="py-3 font-bold text-white">${(p.LikesN||0).toLocaleString()}</td>
          <td class="py-3">${p.Link ? `<a href="${p.Link}" target="_blank" class="text-neon-cyan underline text-xs">Link</a>` : `<span class="text-gray-600 text-xs">‚Äî</span>`}</td>
      </tr>`).join("") || '<tr><td colspan="3" class="p-4 text-center text-gray-600">–ù–µ—Ç –∑–∞–≥—Ä—É–∑–æ–∫</td></tr>';

  renderCharts(curr);
}

function renderSettingsBox() {
  const s = STATE.settings;
  if (!s) { $("settingsBox").innerText = "‚Äî"; return; }

  const pickKeys = [
    "Private Account",
    "Allow DownLoad",
    "Allow Others to Find Me",
    "Allow Reuse of Content",
    "Personalized Ads",
    "Filter Comments",
    "App Language"
  ];

  const rows = [];
  for (const k of pickKeys) {
    if (Object.prototype.hasOwnProperty.call(s, k)) {
      rows.push(`<div class="flex justify-between gap-6 border-b border-[#222] py-2">
        <div class="text-gray-500">${k}</div>
        <div class="text-white font-bold">${String(s[k])}</div>
      </div>`);
    }
  }

  $("settingsBox").innerHTML = rows.length
    ? rows.join("")
    : `<div class="text-gray-600">SettingsMap –Ω–∞–π–¥–µ–Ω, –Ω–æ –∫–ª—é—á–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –ø–æ–¥ —Ç–≤–æ–π —ç–∫—Å–ø–æ—Ä—Ç.</div>`;
}

// ---------- CHARTS ----------
let chartV, chartL, chartC, chartP, chartSec;

function renderCharts(curr) {
  const labels = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];

  const postsCount = groupByMonthCount(curr.posts);
  const postsLikesSum = groupByMonthSum(curr.posts, p => (p.LikesN || 0));
  const loginsCount = groupByMonthCount(curr.logins);

  if (chartV) chartV.destroy();
  if (chartL) chartL.destroy();
  if (chartC) chartC.destroy();
  if (chartP) chartP.destroy();
  if (chartSec) chartSec.destroy();

  // Views
  const ctxV = $("chartViews").getContext('2d');
  const gradV = ctxV.createLinearGradient(0,0,0,300);
  gradV.addColorStop(0, 'rgba(255,255,255,0.12)');
  gradV.addColorStop(1, 'rgba(255,255,255,0)');
  chartV = new Chart(ctxV, {
    type: 'line',
    data: { labels, datasets: [{ label: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', data: groupByMonthCount(curr.watch), borderColor: '#fff', backgroundColor: gradV, fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}},
      scales: { x: {grid: {display: false}, ticks: {color: '#555'}}, y: {grid: {color: '#222'}} } }
  });

  // Likes
  const ctxL = $("chartLikes").getContext('2d');
  chartL = new Chart(ctxL, {
    type: 'line',
    data: { labels, datasets: [{ label: '–õ–∞–π–∫–∏', data: groupByMonthCount(curr.likes), borderColor: '#FE2C55', backgroundColor: '#FE2C55', tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}},
      scales: { x: {grid: {display: false}, ticks: {color: '#555'}}, y: {grid: {color: '#222'}} } }
  });

  // Comments
  const ctxC = $("chartComments").getContext('2d');
  chartC = new Chart(ctxC, {
    type: 'line',
    data: { labels, datasets: [{ label: '–ö–æ–º–º–µ–Ω—Ç—ã', data: groupByMonthCount(curr.comments), borderColor: '#25F4EE', backgroundColor: '#25F4EE', tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}},
      scales: { x: {grid: {display: false}, ticks: {color: '#555'}}, y: {grid: {color: '#222'}} } }
  });

  // Posts + likes sum
  const ctxP = $("chartPosts").getContext('2d');
  chartP = new Chart(ctxP, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: '–ü–æ—Å—Ç—ã', data: postsCount, borderColor: '#A78BFA', backgroundColor: 'rgba(167,139,250,0.35)', borderWidth: 1, yAxisID: 'y' },
        { label: '–õ–∞–π–∫–∏ (—Å—É–º–º–∞)', data: postsLikesSum, type: 'line', borderColor: '#FB7185', backgroundColor: '#FB7185', tension: 0.35, borderWidth: 2, pointRadius: 0, yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#555' } },
        y: { grid: { color: '#222' }, ticks: { color: '#555' }, title: { display: true, text: '–ü–æ—Å—Ç—ã' } },
        y1: { position: 'right', grid: { display: false }, ticks: { color: '#555' }, title: { display: true, text: '–õ–∞–π–∫–∏' } }
      }
    }
  });

  // Logins
  const ctxS = $("chartLogins").getContext('2d');
  chartSec = new Chart(ctxS, {
    type: 'line',
    data: { labels, datasets: [{ label: '–õ–æ–≥–∏–Ω—ã', data: loginsCount, borderColor: '#34D399', backgroundColor: '#34D399', tension: 0.35, borderWidth: 2, pointRadius: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}},
      scales: { x: {grid: {display: false}, ticks: {color: '#555'}}, y: {grid: {color: '#222'}} } }
  });
}

// ---------- EVENTS ----------
$("fileInput").addEventListener("change", async (e) => {
  const f = e.target.files[0];
  if (!f) return;

  try {
    const years = await processFile(f);

    const sel = $("yearSelect");
    sel.innerHTML = years
      .map(y => `<option value="${y}">${y === "ALL" ? "ALL (–≤—Å—ë)" : y}</option>`)
      .join("");

    $("controls").classList.remove("hidden");
    $("dashboard").classList.remove("hidden");
    $("status").innerText = "";
    $("status").classList.remove("loading");

    // –í–ê–ñ–ù–û: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –≥–æ–¥),
    // –∞ ALL –±—É–¥–µ—Ç –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞.
    sel.value = years[0];
    renderUI(sel.value);

    sel.onchange = () => renderUI(sel.value);
  } catch(e) {
    console.error(e);
    $("status").innerText = "–û—à–∏–±–∫–∞: " + e.message;
    $("status").classList.remove("loading");
  }
});
</script>
</body>
</html>
